name: Publish Python ðŸ distributions ðŸ“¦ to PyPI
on:
    release:
        types:
            - published
jobs:
    publish:
        name: Build and publish Python ðŸ distributions ðŸ“¦ to PyPI and TestPyPI
        runs-on: ubuntu-latest
        permissions:
            contents: write
            packages: write
            id-token: write 
#        environment:
#            name: testpypi
#            url: https://test.pypi.org/p/polypheny-prism-api
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python 3.8
              uses: actions/setup-python@v5
              with:
                  python-version: 3.8
            - name: Set Version
              id: version
              run: |
                  if [[ "${{ github.event_name }}" == "release" && "${{ github.event.action }}" == "published" ]]; then
                      echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
                  else
                      TIMESTAMP=$(date +'%Y%m%d%H%M%S')
                      echo "VERSION=0.0.dev${TIMESTAMP}" >> $GITHUB_ENV
                  fi
            - name: Download protobuf for Linux
              run: |
                  curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v26.0/protoc-26.0-linux-x86_64.zip
                  unzip protoc-26.0-linux-x86_64.zip
            - name: Build Protobuf Files
              run: bin/protoc --experimental_allow_proto3_optional -I . --python_out . org/polypheny/prism/*.proto
            - name: Build package
              run: python setup.py sdist
              env:
                  VERSION: ${{ env.VERSION }}
#            - name: Publish distribution ðŸ“¦ to Test PyPI
#              uses: pypa/gh-action-pypi-publish@release/v1
#              with:
#                  repository-url: https://test.pypi.org/legacy/
            - name: Publish distribution ðŸ“¦ to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
